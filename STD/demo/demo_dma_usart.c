#include "sys.h"
#include "delay.h"
#include "usart.h"
#include "led.h"
#include "oled_hw_spi.h"
#include "key.h"
#include "dma_usart.h"

#define SEND_BUF_SIZE 8200 //发送数据长度,最好等于sizeof(TEXT_TO_SEND)+2的整数倍.

u8 SendBuff[SEND_BUF_SIZE]; //发送数据缓冲区
const u8 TEXT_TO_SEND[] = {"Mcudev STM32F4 DMA 串口实验"};

int main(void)
{
    u16 i;
    u8 t = 0;
    u8 j, mask = 0;
    float pro = 0;                                  //进度
    NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2); //设置系统中断优先级分组2
    delay_init(168);                                //初始化延时函数
    uart_init(115200);                              //初始化串口波特率为115200
    LED_Init();                                     //初始化LED
    KEY_Init();                                     //按键初始化
    SPI2_Init();
    oled_init();
    OLED_ShowString(0, 0, "STM32F4 DMA TEST", 12);
    OLED_Refresh_Gram();

    MYDMA_Config(DMA2_Stream7, DMA_Channel_4, (u32)&USART1->DR,
                 (u32)SendBuff, SEND_BUF_SIZE); //DMA2,STEAM7,CH4,外设为串口1,存储器为SendBuff,长度为:SEND_BUF_SIZE.
    //显示提示信息
    j = sizeof(TEXT_TO_SEND);
    for (i = 0; i < SEND_BUF_SIZE; i++) //填充ASCII字符集数据
    {
        if (t >= j) //加入换行符
        {
            if (mask)
            {
                SendBuff[i] = 0x0a;
                t = 0;
            }
            else
            {
                SendBuff[i] = 0x0d;
                mask++;
            }
        }
        else //复制TEXT_TO_SEND语句
        {
            mask = 0;
            SendBuff[i] = TEXT_TO_SEND[t];
            t++;
        }
    }
    i = 0;
    while (1)
    {
        t = KEY_Scan(0);
        if (t == KEY0_PRES) //KEY0按下
        {
            printf("\r\nDMA DATA:\r\n");
            // LCD_ShowString(30, 150, 200, 16, 16, "Start Transimit....");
            // LCD_ShowString(30, 170, 200, 16, 16, "   %");  //显示百分号
            OLED_ShowString(0, 12, "Start Transimit....", 12);
            OLED_ShowString(0, 24, "   %", 12);
            OLED_Refresh_Gram();

            USART_DMACmd(USART1, USART_DMAReq_Tx, ENABLE); //使能串口1的DMA发送
            MYDMA_Enable(DMA2_Stream7, SEND_BUF_SIZE);     //开始一次DMA传输！
            //等待DMA传输完成，此时我们来做另外一些事，点灯
            //实际应用中，传输数据期间，可以执行另外的任务
            while (1)
            {
                if (DMA_GetFlagStatus(DMA2_Stream7, DMA_FLAG_TCIF7) != RESET) //等待DMA2_Steam7传输完成
                {
                    DMA_ClearFlag(DMA2_Stream7, DMA_FLAG_TCIF7); //清除DMA2_Steam7传输完成标志
                    break;
                }
                pro = DMA_GetCurrDataCounter(DMA2_Stream7); //得到当前还剩余多少个数据
                pro = 1 - pro / SEND_BUF_SIZE;              //得到百分比
                pro *= 100;                                 //扩大100倍
                // LCD_ShowNum(30, 170, pro, 3, 16);
                OLED_ShowNum(0, 24, pro, 3, 12);
                OLED_Refresh_Gram();
            }
            // LCD_ShowNum(30, 170, 100, 3, 16);                            //显示100%
            OLED_ShowNum(0, 24, 100, 3, 12);
            // LCD_ShowString(30, 150, 200, 16, 16, "Transimit Finished!"); //提示传送完成
            OLED_ShowString(0, 12, "Transimit Finished!", 12);
            OLED_Refresh_Gram();
        }
        i++;
        delay_ms(10);
        if (i == 20)
        {
            LED0 = !LED0; //提示系统正在运行
            i = 0;
        }
    }
}
